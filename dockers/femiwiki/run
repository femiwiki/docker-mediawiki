#!/bin/bash
set -euxo pipefail; IFS=$'\n\t'

chmod +x /usr/local/bin/prerun
/usr/local/bin/prerun

echo 'Starting Femiwiki ...'

# Run Install.php
if [ -z "${MEDIAWIKI_SKIP_INSTALL:-}" ]; then
  echo 'Start installing Mediawiki ...'
  php /srv/femiwiki.com/maintenance/install.php \
    --lang ko \
    --scriptpath '/w' \
    --dbtype mysql \
    --dbname femiwiki \
    --dbserver "${WG_DB_SERVER}" \
    --dbuser "${WG_DB_USER}" \
    --dbpass "${WG_DB_PASSWORD}" \
    --installdbuser "${WG_DB_USER}" \
    --installdbpass "${WG_DB_PASSWORD}" \
    --pass 'admin_password_please_change' \
    '페미위키' Admin
fi

# Overwrite LocalSettings.php generated by install script
cp -f /a/LocalSettings.php /srv/femiwiki.com/LocalSettings.php

if [ -n "${MEDIAWIKI_HOTFIX_SNIPPET:-}" ]; then
  cat <<EOF > /a/Hotfix.php
${MEDIAWIKI_HOTFIX_SNIPPET}
EOF
fi

# Run update script
if [ -z "${MEDIAWIKI_SKIP_UPDATE:-}" ]; then
  /srv/femiwiki.com/maintenance/update.php --quick
fi

# Add Femiwiki to the sites table
if [ -z "${MEDIAWIKI_SKIP_IMPORT_SITES:-}" ]; then
  php /srv/femiwiki.com/maintenance/importSites.php /a/site-list.xml
fi

# Start cron daemon
cron

chmod +x /usr/local/bin/postrun
/usr/local/bin/postrun

# Run php-fpm
php-fpm
