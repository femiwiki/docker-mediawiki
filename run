#!/bin/bash
set -euo pipefail; IFS=$'\n\t'

echo 'Starting Femiwiki ...'

# Install.php 실행
if [ -z ${MEDIAWIKI_SKIP_INSTALL:-} ]; then
  echo 'Start installing Mediawiki ...'

  if [ ! -e /a/secret.php ]; then
    curl -Lsfo /a/secret.php https://raw.githubusercontent.com/femiwiki/docker-mediawiki/main/configs/secret.php.example
  fi

  DB_HOSTNAME="$(php -r 'require "/a/secret.php"; echo $wgDBserver;')"
  DB_USERNAME="$(php -r 'require "/a/secret.php"; echo $wgDBuser;')"
  DB_PASSWORD="$(php -r 'require "/a/secret.php"; echo $wgDBpassword;')"

  php /srv/femiwiki.com/maintenance/install.php \
    --lang ko \
    --scriptpath '/w' \
    --dbtype mysql \
    --dbname femiwiki \
    --dbserver "${DB_HOSTNAME}" \
    --dbuser "${DB_USERNAME}" \
    --dbpass "${DB_PASSWORD}" \
    --installdbuser "${DB_USERNAME}" \
    --installdbpass "${DB_PASSWORD}" \
    --pass 'admin_password_please_change' \
    '페미위키' Admin
fi

# Overwrite LocalSettings.php generated by install script
ln -sf /config/mediawiki/LocalSettings.php /srv/femiwiki.com/LocalSettings.php

# Run update script
if [ -z ${MEDIAWIKI_SKIP_UPDATE:-} ]; then
  /srv/femiwiki.com/maintenance/update.php --quick
fi
# Update localisations for MediaWiki messages in the background
# Temporarily disabled @See https://github.com/femiwiki/mediawiki/issues/216
# php /srv/femiwiki.com/extensions/LocalisationUpdate/update.php &

# Add Femiwiki to the sites table
if [ -z ${MEDIAWIKI_SKIP_IMPORT_SITES:-} ]; then
  php /srv/femiwiki.com/maintenance/importSites.php /config/mediawiki/site-list.xml
fi

# Start cron daemon
cron

# Run php-fpm
php-fpm
